# WebRTCについて調べた

こんにちは、

Webの記事と本2冊買って読んでみたので、

一度、現状の理解を書いてみます。

ちなみに買った本は下の本と、

<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=birdmangai-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4897979587&linkId=665782d06862993df268e4a90b5c51cd"></iframe>

**わか(った気にな)るWebRTC**の電子版です。

https://booth.pm/ja/items/504677

読む順番としては、わか(った気にな)るWebRTCを読んで、

ざっくり概要を頭に入れてわかった気になってから、リックテレコムのWebRTCの本を読むと良いと思います。

いきなりリックテレコムから入ると心が折れること間違い無し。

最近、リックテレコムから販売されている本を買うことが増えてきた。



## この記事で分かること

WebRTCってそもそも何か、どういうところで使われてて、

どんなプロトコルが用意されているかが分か(った気にな)るようになります。



## なんで調べたの？

Twilioを使うにあたって、Twilioがそのあたり難しい部分を吸収したライブラリやSDKを用意してくれてるけど、

デバッグするにあたってあまりにも分からないことが多すぎたため。

Twilio使わないから知らなくても良いや〜って思わず、ネットワークについての勉強になるし、

最近ではiOS11からWebRTC対応されスマホ全般で使える技術となったので、

Web系の開発をしている人は押さえておくべき技術になっていくでしょう。



## WebRTCってそもそも何？

Web Real Time Communicationの略。名前の通り、

ブラウザでリアルタイム性を持つコミュニケーション全般を取り扱います。

コミュニケーションは具体的に、音声通話や動画(ビデオチャット)などを指します。



特長はインターネット回線につながっているブラウザさえあれば、

上記コミュニケーションを行える点です。

もう電話機や専用のソフトウェアは必要なくなります。



## WebRTCを使っているサービスは何がある？

**Twilio**

**appear.in**

**Slack音声通話**

などがあります。使ったことがあるサービスがあると思います。



## リアルタイムコミュニケーションってどうやってるの？

1. 入出力の許可をユーザによって行わせる
   * 不正にユーザの情報を収集しづらくするために、ユーザに許可・拒否を選択させる
2. エンドポイント同士の接続の確立
   * 次に詳細な説明を書きます
3. エンドポイント同士のデータ交換
   * データ交換によって、音声通話やビデオチャットが可能になります
4. 接続の終了



## エンドポイント同士の接続の確立って難しそうだね？

はい、難しいですね

接続の確立について、オファーアンサーネゴシエーションという

ローカルとリモートの設定を交換する手法があります。

1. 接続を試みる側がどのメディアどのデコードで送るかをオファーとして送る
2. 受け手側は、送られたオファーに対して、対応可能かと他に使いたいものリストをアンサーとしてオファー側に送る
3. アンサーを受取、各エンドポイント同士で受け取った情報を設定することでデータ交換が行えるようになる



## ネットワークの制限

セキュリティを高めるためのファイアウォールやNATが

接続の設立にあたっては障害となる。

その回避を行うため、特別なプロトコルが用意されています。



### NAT is 何？

Network Address Translatorの略。

IPアドレスは有限の資源であり、資源の有効活用のために使われる。

グローバルIPをNAT機能持ちルータで、ルータ内のプライベートIPとの変換を行う技術。

NAPTであることがほとんどで、ポートの変換も行うことが多い。

正確にはNAPTだけど、一旦NATで統一します。



エンドポイント同士が接続されるWebRTCだが、

NATの存在のため、接続先エンドポイントがどのプライベートIPを持っているかが

外側からは分からないため、下記**NAT越え**が行われる。



### NAT越え is 何？

上記問題への対応のため、エンドポイントに直接パケットを送るために行われる手法・技術。

具体的には、ホールパンチという手法でNATを透過したテストパケットを送れるかどうかを試す。



### ホールパンチ is 何？

NATの外から、プライベートIPアドレスとポート番号のペアを知るために行われる手法。

具体的には下記手法を試していく。



### ICE is 何？

Interactive Connectivity Establishmentの略。

NAT越えを行うための手法の一つ。ICEでは下記を行う。

* IPアドレスとポート番号のペアを集める
* エンドポイント同士がペアを交換する
* ホールパンチを試す
* 繋がるペアでデータ交換を行う

また、VanillaとTrickleという拡張がある。



#### Vanilla ICE is 何？

標準のICEを指す。拡張であるTrickleが出来たため、標準がVanillaと呼ばれる。

VanillaはすべてのIPアドレスとポート番号のペアを収集してから

すべて接続を試し、接続確立されたものから使用するペアを選択する。

バニラ自体には標準である意味がある。

ICEという名前のためのシャレみたいなもんでしょうね。



#### Trickle ICE is 何？

標準のICEに対し、拡張されたICEを指す。

Vanillaに対し、Trickleではペアを順次交換し、接続成功した時点で処理が終了されるので、

接続確立までがVanillaよりも速くできる可能性がある。

現時点ではChrome/Firefoxと一部ブラウザでしか対応していないため、

使用する際には最新の情報を調べてください。



Trickleは滴り落ちるという意味なので、ペアを少しずつ試すという点が

アイスが滴り落ちるのと様子に似ているからこの名前なんだと思います。



### STUN is 何？

Session Traversal Utilities NAT の略。

これもNAT越えのための手法のひとつ。

STUNで対象のエンドポイントのネットワーク上にNATが存在するかどうかを確認するプロトコル。



テストパケットを送り、自分のIPが相手のネットワーク上からどういうIPで見えるかを確認します。

自分のIPと一致していれば、NATは存在しません。

存在しなければ、NAT越えの必要なくパケットを送ることが出来ます。

ただ、ほとんどのケースでIPが一致せず、NATが存在します。



### TURN is 何？

TURN の略。

STUNでテストした結果、NATが存在する場合、実際に接続を行うプロトコル。





## **SIP is 何？**

Session Initiation Protocolの略。

IP電話などでこのSIPというプロトコルが使われています。

各ユーザのエンドポイント同士を繋ぐための、規約をSIPで取り決めています。

ここでいうエンドポイントは加入電話機やIP電話機などです。

NTT回線にあるネットワークとWebのネットワークが繋がるってなにげにすごい。



SIPは名前の通り、エンドポイント同士のセッションを開始するための規約です。