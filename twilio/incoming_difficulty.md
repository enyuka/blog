# この記事の主張

* 一番難しいのは受電の仕様決めである
* 保留も難しいと言われるが、保留の実装はドキュメントだけで解決する
* 手を動かす前に、仕様洗い出しと実装のイメージ作りをしましょう



こんにちは。

弊社では営業管理ツールリニューアルに伴い、

電話システムも某IP電話から、Twilioへの置き換えを行い、新たにCTIの仕組みを導入しています。

僕はTwilioに触る前まで、IP電話のサービスを使ってなかったし、

Twilioはお恥ずかしながら名前も知りませんでした。



1年ほどで得た経験を基に受電の難しさをまとめますので、参考にしてください。

この記事に書いてある内容はTwilioに詳しい人に質問できる環境にありながらも、

基本的には1人で得た知識と経験のため、これがベストプラクティスではないです。

むしろあったら教えて欲しい。



## なぜ受電が難しいのか

IP電話やTwilioについて詳しくない人が、

そもそもネットワークを用いた電話の仕組みを理解できていないからです。

携帯電話はほとんどの人が持っていますが、仕組みが全く異なります。



### 電話番号1つに対して、通話を発信・着信できる端末が複数ある

普通の携帯電話は電話番号1つに対して、その番号を使って発信・着信できる端末は1つだけです。

ですが、Twilioでは1つの電話番号で、複数人が同時に発信・着信できます。

一般的に思い込んでいる、電話番号と端末が1対1なのに対し、Twilioは一対多の関係にあります。

もちろん、1対1の作りでも構築できますが、月額108円が最低でも1人ずつにかかり、

管理コストも膨大なことになります。



これはTwilioが提供しているJavaScriptライブラリや、iOS/AndroidのSDKを使用し、

ブラウザなりアプリなりで仮想電話端末を実装することで解決します。

言われれば当然ですが、いざやってみないと身にしみて分からないこともあります。

これが難しさの一つ目。



### 同じ電話番号にかかってきた通話を誰に割り振るかを考えないといけない

先のことを理解した時に、この問題にぶつかります。

Twilioへ指示を出すことで誰に割り振るかの指示は出せますが、

誰に割り振るか自体は自分たちで考える必要があります。



この時点で、システムだけでは解決できず、現場で仕事している

営業やオペレーターなどと連携が必要です。

また、先の事実はエンジニアであればすぐに理解できるかもしれませんが、

必ずしもITリテラシーの高い人以外へ納得性のある説明をした上で、

現場でどう割り振るのがベストなのかコミュニケーションを取る必要があります。



考えたことのない技術に触れながら、現場の知識も取り込んでいかないといけない。

ここが難しさの2つ目です。



### リアルタイムとの戦い

仕様も無事に決まりました。次に襲いかかる問題がこれです。

一般的なWebエンジニアであれば、実戦経験の少ない

リアルタイムとの戦いが待っています。



受電した通話を誰に割り振るかは決まっても、

その人が在席していないとその通話は空振りになりお客様を待たせることになります。

そこでかかってきた時点のオペレーターの状態を取得する必要があります。



#### リアルタイムで状態を取得

下記3つが簡単に思いつきます。

1. DBなどに保持し、問い合わせてみる
2. Twilio.Syncを使ってみる
3. Twilio.Taskrouterを使ってみる



1について、在席状態を管理するために、

逐一ajaxなどでその人の状態をupdateし続ける必要があります

これはサバクラ両方を1人でスクラッチしつつ、

保守フェーズですべて管理する必要があります。

人数が少なければ可能かもしれないが、あまり現実的ではなさそうです。



2について、Twilioが提供しているWebsocketを用いた、

リアルタイム通信ができる機能です。

最初に僕がやってみたのがこれでした。

ただこの機能は検索しづらく、500件のデータを入れたSyncを検索した所、

10秒ほどかかってしまい、受電で使うには難しかったです。

人数次第では選択肢に入ってくるかもしれませんが、実装した上で弊社では採用しませんでした。



3について、Twilioが提供しているACDです。

ACDとは通話を誰に割り振るか分配する機能です。

ロードバランサーというとイメージが付きやすいと思います。



最終的に弊社で採用したのはTaskrouterです。

