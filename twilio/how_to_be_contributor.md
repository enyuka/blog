# Twilio Clientのコントリビューターになったので経緯の紹介

こんにちは、[@24guchia](https://twitter.com/24guchia)です。

先日、Twilio Clientの不具合を見つけ、
修正依頼をKDDIウェブコミュニケーションズ社に依頼しました。
その後、バグは無事修正され、しかもその依頼がバグ改修の助けになったとのことで、
Twilio ClientのChangelogに名前を残してもらえることになりました！

https://www.twilio.com/docs/voice/client/javascript/changelog?fbclid=IwAR2QrKLbiqkuoZEFhN22gFVACpzVc_vxvViJQQNNOeaFYmu5tL23oOMvigo#172-may-3-2019

他のChangelogを見てもらえば分かる通り、
このような記載はなく、貢献が認められ技術者として嬉しい限りです。

せっかくなので、どのようなことをしたか経緯をまとめます。
このようなバグなどを見つけても、以前はオープンソースじゃなかったため、
モチベーションが上がらないというのがあったかもしれませんが、
貢献が認められこともあるので、ぜひみなさんもバグを見つけたら
改修依頼をしましょう。

## 当時の環境

下記環境でテストしていました。

* Chrome M72 beta
* Twilio Client v.1.4.35
* Clientを内製したChrome Extensionで読み込む

ChromeがM71→72になるにあたり、
SDPのデフォルト記述法がPlan BからUnified Planに変わる
とのことで、Twilio Clientもそれに追従するため、
バージョンアップを控えていました。

ClientはTwilio日本ユーザの間では、
自動アップデートせず、実際に使用する環境でテストして、
問題がないことを確認してからClientをバージョンアップすることが通説になっています。
というのも、こういうバグが発生し、突然動かなくなることがあるからです。
Clientに限らず、この手のものは手動アップデートをおすすめします。

そのため、M72ベータにバージョンアップしたTwilio Clientを適用し、
疎通テストを行ったところ、なんと音が出なくなるバグを見つけてしまいました。

## バグ改修までの経緯

該当のバグはTwilio Clientを更新せずに、
数十回、連続で通話すると通話の音が聞こえなくなるという
致命的なものでした。
しかし、Twilioの日本ユーザグループのSlackで聞いても、
そんなことあるんですか？という感じで、解決しませんでした。

そのため、自分で調査することを決めました。

### 原因を探る

ChromeでWebRTCプロダクトを開発している人なら必ず見る、
webrtc-internalsとmedia-internalsを見ていました。
以前使用していたバージョンとの挙動を確認しつつ、
media-internalsを見ていたところ挙動に違いを見つけました。

新しいバージョンで電話を受けると、
複数のMediaオブジェクトがポーズ状態で残っていました。
以前のバージョンではポーズではなく、破棄されていました。

そのため、Mediaオブジェクトに問題があると推定し、
再現方法を探ることにしました。

当時のメモによると、受電すると3つMediaオブジェクトが生成され、
約15通話で音が出なくなるため、だいたい45個のMediaオブジェクトが残ると、
音声再生に不具合が発生するようだと書いてありました。

### 問題の切り分け

原因はわかりましたが、問題の発生箇所は
Twilio ClientなのかChromeなのか、この時点では断定できていません。

そこでかんたんにMediaオブジェクトを増やせる、
みんな大好きYoutubeをたくさん開くことで
再現するかを試しました。
ChromeでYoutubeの適当な動画を再生すると、
1つMediaオブジェクトが生成されることが
media-internalsの挙動を見てわかりました。

上に45個のMediaオブジェクトで音声再生に不具合が発生しそう
と書きましたが、正確な数は不明です。
そこで、一気に同じ動画を100タブ分、開いてみたところ、
見事に音声再生で不具合が発生しました！
Youtubeでこんな不具合が起きるんですよ。
このとき、初めて知りました。

TODO 画像

